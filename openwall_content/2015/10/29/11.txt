  oss-security - Xen Security Advisory - x86: populate-on-demand  balloon size inaccuracy can crash guests            Products  Openwall GNU/*/Linux   server OS Linux Kernel Runtime Guard John the Ripper   password cracker  Free & Open Source for any platform in the cloud Pro for Linux Pro for macOS  Wordlists   for password cracking passwdqc   policy enforcement  Free & Open Source for Unix Pro for Windows (Active Directory)  yescrypt   KDF & password hashing yespower   Proof-of-Work (PoW) crypt_blowfish   password hashing phpass   ditto in PHP tcb   better password shadowing Pluggable Authentication Modules scanlogd   port scan detector popa3d   tiny POP3 daemon blists   web interface to mailing lists msulogin   single user mode login php_mt_seed   mt_rand() cracker  Services Publications  Articles Presentations  Resources  Mailing lists Community wiki Source code repositories (GitHub) Source code repositories (CVSweb) File archive & mirrors How to verify digital signatures OVE IDs  What's new         Follow @Openwall on Twitter for new release announcements and other news   [<prev] [next>] [day] [month] [year] [list]  Date: Thu, 29 Oct From: Xen.org security team <security@....org> To: xen-announce@...ts.xen.org, xen-devel@...ts.xen.org,  xen-users@...ts.xen.org, oss-security@...ts.openwall.com CC: Xen.org security team <security@....org> Subject: Xen Security Advisory - x86: populate-on-demand  balloon size inaccuracy can crash guests  -----BEGIN PGP SIGNED MESSAGE----- Hash: SHA1              Xen Security Advisory /                               version 3       x86: populate-on-demand balloon size inaccuracy can crash guests  UPDATES IN VERSION 3 ====================  Public release.  ISSUE DESCRIPTION =================  The design of the memory populate-on-demand (PoD) system requires that a guest's memory ballooning driver reach its memory reduction target. The target is not entirely well-defined in terms of the information visible to the appropriate parts of the system, so some unknown set of guests (but probably most guests) will fail this criterion.  If the guest memory balloon driver does not free sufficient memory to reach its target, the guest will proceed to run with a nonzero number of outstanding PoD pages.  When the guest or management toolstack touches such a page, the hypervisor would search the guest memory for a page containing only zeroes.  If no such page is found, the guest crashes.  Prior to the patch for the search might lock up the relevant physical cpu for a while.  After the patch to it might crash the guest even if a suitable zero page is available.  This means that in the current arrangements toolstack software must apply an adjustment to a guest's PoD target as supplied to Xen. Neither xend nor libxl do this.  IMPACT ======  Guests configured with PoD might be unstable, especially under load.  In an affected guest, an unprivileged guest user might be able to cause a guest crash, perhaps simply by applying load so as to cause heavy memory pressure within the guest.  This problem also allows an unprivileged guest user to exercise the separate vulnerability described in an unprivileged guest user might be able to cause a denial of service affecting the host.  VULNERABLE SYSTEMS ==================  The vulnerability is restricted to HVM guests which have been constructed in Populate-on-Demand mode (ie, with memory < maxmem).  ARM is not vulnerable.  x86 PV VMs are not vulnerable.  x86 HVM domains without PoD (ie started with memory==maxmem, or without mentioning "maxmem" in the guest config file) are not vulnerable.  Systems using libxl (whether via xl, or libvirt, or another higher layer) or xend (whether via xm, or libvirt, or another higher layer) are vulnerable.  If the system has been stress-tested (by imposing memory load on the guest) and found to be stable, it is less likely that the guest is vulnerable.  Combinations of Xen, guest, guest balloon driver, and toolstack software, which have an empirical adjustment as described in the Description, and which have been formally stress-tested in PoD mode, are less likely to be vulnerable.  Migration is not capable of creating a guest with outstanding PoD.  So migrating a guest which is vulnerable might crash it.  However, if a guest has been migrated successfully since it booted, it is no longer vulnerable.  Xen versions back to 3.4.x are affected.  Vulnerability of a particular guest can be tested by the host administrator using the utility attached to this advisory.   MITIGATION ==========  Reducing the guest's memory target, after guest startup, can cause the guest's ballon driver to eliminate the PoD discrepancy.  If the guest successfully balloons down, it will no longer be vulnerable.  On systems using libxl this can be done with `xl mem-set', during or after each guest boot:     # `xl domid name-of-guest`    checked domain for VULNERABLE (1 more outstanding pages)    try using   xl mem-set   to reduce its memory by 1 (Mby)    or perhaps reduce by 4    # xl list name-of-guest    Name                  ID   Mem VCPUs      State   Time(s)    name-of-guest              2     r-----        # xl mem-set name-of-guest    #    [ wait for guest to give up memory ]    # `xl domid name-of-guest`    checked domain for NOT vulnerable    #  Alternatively, no matter the toolstack, it is possible for a host administrator to bypass the toolstack code and give ballooning instructions directly to the guest:     [ suppose guest domid is eg from xl domid name-of-guest  ]    #    checked domain for VULNERABLE (1 more outstanding pages)    try using   xl mem-set   to reduce its memory by 1 (Mby)    or perhaps reduce by 4    # xenstore-read       # xenstore-write    #    [ wait for guest to give up memory ]    # `xl domid name-of-guest`    checked domain for NOT vulnerable    #  The memory/target value is in decimal, and is a number of kilobytes; it must be a multiple of 4, since a page is 4 Kb on affected systems. The value to write should be some amount less than the value read.   It is not currently known whether use of the VM memory event inspection facilities (in-tree, this means the xc_monitor utility) might invalidate the workaround.   Note that guests may become unstable if given too little memory, so large reductions of the memory target should be applied with caution, if at all.  The expected offset related to is small (tens of pages, perhaps).  If a large reduction is required, it is more likely that either the guest is still booting up (and still working to reduce the PoD memory), or that the guest's balloon driver is not functioning:     # `xl domid name-of-guest`    checked domain for VULNERABLE more outstanding pages)    difference is >1Mby    ballon driver not running or guest still booting?    #  A guest without a working balloon driver will be unstable in PoD mode, especially under memory pressure; this is an inherent feature of the design of PoD.   RESOLUTION ==========  The attached patch fixes the problem for systems using libxl (via xl, or via libvirt, or another higher layer).  At the time of writing there is no patch for xend-based systems.             xen-unstable, Xen 4.5, Xen 4.6            Xen 4.1 to 4.4 inclusive, using libxl  (Xend was removed in Xen 4.5; so the libxl-only patch is always sufficient for Xen 4.5 and later.)  $   $  DEPLOYMENT DURING EMBARGO =========================  Deployment of the patches and/or mitigations described above (or others which are substantially similar) is permitted during the embargo, even on public-facing systems with untrusted guest users and administrators.  But: Distribution of updated software is prohibited (except to other members of the predisclosure list).  Predisclosure list members who wish to deploy significantly different patches and/or mitigations, please contact the Xen Project Security Team.   (Note: this during-embargo deployment notice is retained in post-embargo publicly released Xen Project advisories, even though it is then no longer applicable.  This is to enable the community to have oversight of the Xen Project Security Team's decisionmaking.)  For more information about permissible uses of embargoed information, consult the Xen Project community's agreed Security Policy:   http://www.xenproject.org/security-policy.html   NOTE REGARDING SHORT EMBARGO ============================  This issue was quickly encountered by the Security Team during our investigations of the scope and impact of this issue was originally discussed in the `Incomplete Information' section of v1.  Accordingly is embargoed and the embargo will end at the same time as that of -----BEGIN PGP SIGNATURE----- Version: GnuPG (GNU/Linux)  iQEcBAEBAgAGBQJWMgofAAoJEIP+FMlX6CvZaqUIAIzgbftJMwo2ywcWycAGzeDS =vBPN -----END PGP SIGNATURE-----  Download attachment of type "application/octet-stream" bytes)  Download attachment of type "application/octet-stream" bytes)  Powered by blists - more mailing lists  Please check out the  Open Source Software Security Wiki, which is counterpart to this mailing list.  Confused about mailing lists and their use? Read about mailing lists on Wikipedia and check out these guidelines on proper formatting of your messages.      