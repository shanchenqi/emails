  oss-security - X41 D-Sec GmbH Security Advisory Memory Corruption  Vulnerability in bspatch            Products  Openwall GNU/*/Linux   server OS Linux Kernel Runtime Guard John the Ripper   password cracker  Free & Open Source for any platform in the cloud Pro for Linux Pro for macOS  Wordlists   for password cracking passwdqc   policy enforcement  Free & Open Source for Unix Pro for Windows (Active Directory)  yescrypt   KDF & password hashing yespower   Proof-of-Work (PoW) crypt_blowfish   password hashing phpass   ditto in PHP tcb   better password shadowing Pluggable Authentication Modules scanlogd   port scan detector popa3d   tiny POP3 daemon blists   web interface to mailing lists msulogin   single user mode login php_mt_seed   mt_rand() cracker  Services Publications  Articles Presentations  Resources  Mailing lists Community wiki Source code repositories (GitHub) Source code repositories (CVSweb) File archive & mirrors How to verify digital signatures OVE IDs  What's new         Follow @Openwall on Twitter for new release announcements and other news   [<prev] [next>] [day] [month] [year] [list]  Date: Thu, 9 Jul From: X41 D-Sec GmbH Advisories <advisories@...-dsec.de> To: oss-security@...ts.openwall.com Subject: X41 D-Sec GmbH Security Advisory Memory Corruption  Vulnerability in bspatch  -----BEGIN PGP SIGNED MESSAGE----- Hash:   X41 D-SEC GmbH Security Advisory:  Advisory Memory Corruption Vulnerability in bspatch ================================================================= Severity Rating: High Confirmed Affected Versions: Colin Percival's bsdiff 4.3 Confirmed Patched Versions: FreeBSD's bsdiff (https://svnweb.freebsd.org/base/head/usr.bin/bsdiff/bspatch/bspatch.c) Vendor: Colin Percival Vendor URL: https://www.daemonology.net/bsdiff/ Vendor Reference: None Vector: Patch file Credit: X41 D-SEC GmbH, Luis Merino Status: Public CVE: CWE: CVSS Score: N/A CVSS Vector: N/A Advisory-URL:  Summary and Impact ================== A memory corruption vulnerability is present in bspatch as shipped in Colin Percival’s bsdiff tools version 4.3. Insufficient checks when handling external inputs allows an attacker to bypass the sanity checks in place and write out of a dynamically allocated buffer boundaries.  Even though the patching procedure is usually combined with integrity and authenticity checks, an attacker that is able to deliver a malicious patch can cause heap corruption in the process running bspatch code, when the authenticity checks happen after applying the patches. Depending on their ability to control and shape the heap state before and during the processing of a malicious patch file, remote code execution may be achieved. This has already been demonstrated as a proof-of-concept exploit in by an anonymous author against the FreeBSD bspatch implementation on 32bit architectures.  This issue was initially reported for bspatch in bsdiff “as used in Apple OS X before and other products” with by an anonymous researcher and was partially addressed by several projects, including Android ChromiumOS and FreeBSD during This initial batch of fixes prevented the attack via negative control values.  Nevertheless, huge control values that would integer overflow the sanity checks and allow an attacker writing out of bounds were not fixed. A subsequent patch was released by FreeBSD addressing the remaining issues together with additional hardening. Unfortunately, most of bspatch copies didn’t port this fix.  It is worth mentioning that bsdiff 4.3, as hosted at Colin Percival’s bsdiff website https://www.daemonology.net/bsdiff/, still ships a copy of bspatch.c vulnerable to these issues via both negative and huge control values. All the Linux distributions we have checked shipping bsdiff are building from this sources, with some of them applying the partial fix initially released.  Product Description =================== bsdiff and bspatch are tools for building and applying patches to binary files. They provide an efficient way to apply binary patches for applications update mechanisms.  Analysis ======== Insufficient checks when calculating the buffer offset and size of write operations allows writing out of a heap allocated buffer boundaries.  - - - ------------------8<---------------------------------------------------------     while(newpos<newsize) {         /* Read control data /         for(i=0;i<=2;i++) {             lenread = BZ2bzRead(&cbz2err, cpfbz2, buf, 8);             if ((lenread < 8) || ((cbz2err != BZOK) &&                 (cbz2err != BZSTREAMEND)))                 errx(1, "Corrupt patch\n");             ctrl[i]=offtin(buf);         };         / Sanity-check */         if(newpos+ctrl[0]>newsize)             errx(1,"Corrupt patch\n");     /* Read diff string */     lenread = BZ2_bzRead(&dbz2err, dpfbz2, new + newpos, ctrl[0]); - - - ------------------8<---------------------------------------------------------  When ctrl[0] takes either negative values or big enough values to overflow newpos+ctrl[0], the sanity check in place will pass allowing operations that write out of buffer new boundaries via BZ2_bzRead(). It is worth mentioning that BZ2_bzRead() will truncate ctrl[0] from 64-bit off_t to 32-bit int.  It is expected that an attacker that is able to deliver an specially crafted patch file can gain remote code execution capabilities when certain conditions for exploitation are met.  Proof of Concept ================ A crashing reproducer can be downloaded from  Fix === Please, refer to the FreeBSD advisories and for fixes.  Workarounds =========== As a workaround, only patches passing integrity and authenticity checks should be applied.  Timeline ======== published Partial fix for FreeBSD published at Complete fix for FreeBSD published at X41 Discovers the vulnerability was not or incorrectly fixed upstream and in prominent forks of the code Colin Percival and distros@ notified Public disclosure  About X41 D-SEC GmbH ==================== X41 is an expert provider for application security services. Having extensive industry experience and expertise in the area of information security, a strong core security team of world class security experts enables X41 to perform premium security services. Fields of expertise in the area of application security are security centered code reviews, binary reverse engineering and vulnerability discovery. Custom research and IT security consulting and support services are core competencies of X41. -----BEGIN PGP SIGNATURE-----  =PbNZ -----END PGP SIGNATURE-----  Powered by blists - more mailing lists  Please check out the  Open Source Software Security Wiki, which is counterpart to this mailing list.  Confused about mailing lists and their use? Read about mailing lists on Wikipedia and check out these guidelines on proper formatting of your messages.      