  oss-security - Re: Linux kernel: Exploitable memory corruption due  to UFO to non-UFO path switch            Products  Openwall GNU/*/Linux   server OS Linux Kernel Runtime Guard John the Ripper   password cracker  Free & Open Source for any platform in the cloud Pro for Linux Pro for macOS  Wordlists   for password cracking passwdqc   policy enforcement  Free & Open Source for Unix Pro for Windows (Active Directory)  yescrypt   KDF & password hashing yespower   Proof-of-Work (PoW) crypt_blowfish   password hashing phpass   ditto in PHP tcb   better password shadowing Pluggable Authentication Modules scanlogd   port scan detector popa3d   tiny POP3 daemon blists   web interface to mailing lists msulogin   single user mode login php_mt_seed   mt_rand() cracker  Services Publications  Articles Presentations  Resources  Mailing lists Community wiki Source code repositories (GitHub) Source code repositories (CVSweb) File archive & mirrors How to verify digital signatures OVE IDs  What's new         Follow @Openwall on Twitter for new release announcements and other news   [<prev] [next>] [<thread-prev] [thread-next>] [day] [month] [year] [list]  Date: Sun, 13 Aug From: Andrey Konovalov <andreyknvl@...il.com> To: oss-security@...ts.openwall.com Cc: willemdebruijn.kernel@...il.com, Dmitry Vyukov <dvyukov@...gle.com>,  	Kostya Serebryany <kcc@...gle.com> Subject: Re: Linux kernel: Exploitable memory corruption due  to UFO to non-UFO path switch  On Thu, Aug 10, at PM, Andrey Konovalov <andreyknvl@...il.com> wrote: > Hi! > > syzkaller found an exploitable memory corruption in UFO code in the > Linux kernel, the details are below. > > ### Bug details > > When building a UFO packet with MSG_MORE __ip_append_data() calls > ip_ufo_append_data() to append. However in between two send() calls, > the append path can be switched from UFO to non-UFO one, which leads > to a memory corruption. > > In case UFO packet lengths exceeds MTU, copy = maxfraglen - skb->len > becomes negative on the non-UFO path and the branch to allocate new > skb is taken. This triggers fragmentation and computation of fraggap = > skb_prev->len - maxfraglen. Fraggap can exceed MTU, causing copy = > datalen - transhdrlen - fraggap to become negative. Subsequently > skb_copy_and_csum_bits() writes out-of-bounds. > > A similar issue is present in IPv6 code. > > The bug was introduced in ("[IPv4/IPv6]: UFO > Scatter-gather approach") on Oct 18 > > The fix has been submitted to netdev [1] and should be committed to > mainline and to stable kernels soon. David has also sent an RFC series > to remove UFO completely [2], which should be merged in > > If unprivileged user namespaces are available, this bug can be > exploited to gain root privileges. I'll share the details and the > exploit in a few days. > > Thanks! > > ### Timeline > > - Bug reported to security@...nel.org > - Bug reported to linux-distros@ > - Patch submitted to netdev > - Announcement on oss-security@ > > ### Links > > [1] > > [2]  ### Exploitation  The bug can be exploited by an unprivileged user if:  1. User can set up an interface with UFO enabled and MTU < or such interface is already present in the system. The former is possible from inside a user namespace.  2. User can disable the NETIF_F_UFO interface feature or set the SO_NO_CHECK socket option. The former requires CAP_NET_ADMIN. The latter is only possible after ("udp: disallow UFO for sockets with SO_NO_CHECK option") from Jan 11 Both are possible from inside a user namespace.  In particular, the bug can be exploited by an unprivileged user if unprivileged user namespaces are available.  Below is a link to a proof-of-concept exploit, that gets root on a range of Ubuntu kernels. The exploit triggers an out-of-bounds write on a socket buffer and overwrites skb_shared_info.destructor_arg->callback with a pointer to shellcode. The exploit includes a SMEP and KASLR bypasses, but no SMAP bypass.  Link:  Powered by blists - more mailing lists  Please check out the  Open Source Software Security Wiki, which is counterpart to this mailing list.  Confused about mailing lists and their use? Read about mailing lists on Wikipedia and check out these guidelines on proper formatting of your messages.      