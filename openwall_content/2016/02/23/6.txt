  oss-security - Re: Access to /dev/pts devices via pt_chown and user namespaces            Products  Openwall GNU/*/Linux   server OS Linux Kernel Runtime Guard John the Ripper   password cracker  Free & Open Source for any platform in the cloud Pro for Linux Pro for macOS  Wordlists   for password cracking passwdqc   policy enforcement  Free & Open Source for Unix Pro for Windows (Active Directory)  yescrypt   KDF & password hashing yespower   Proof-of-Work (PoW) crypt_blowfish   password hashing phpass   ditto in PHP tcb   better password shadowing Pluggable Authentication Modules scanlogd   port scan detector popa3d   tiny POP3 daemon blists   web interface to mailing lists msulogin   single user mode login php_mt_seed   mt_rand() cracker  Services Publications  Articles Presentations  Resources  Mailing lists Community wiki Source code repositories (GitHub) Source code repositories (CVSweb) File archive & mirrors How to verify digital signatures OVE IDs  What's new         Follow @Openwall on Twitter for new release announcements and other news   [<prev] [next>] [<thread-prev] [thread-next>] [day] [month] [year] [list]  Date: Tue, 23 Feb From: Solar Designer <solar@...nwall.com> To: oss-security@...ts.openwall.com Subject: Re: Access to /dev/pts devices via pt_chown and user namespaces  On Tue, Feb 23, at halfdog wrote: > Sending content from [0] also to oss-security as requested last time:  Thank you.  This public disclosure is very late, though.  I didn't realize you were still holding some of your findings on this.  > With Ubuntu Wily and earlier, /usr/lib/pt_chown was used to change > ownership of slave pts devices in /dev/pts to the same uid holding the > master file descriptor for the slave.  I think pt_chown is only needed for legacy BSD pty's, and no longer needed for Unix 98 pty's that Linux systems use these days.  Perhaps it should be dropped from upstream glibc by now.  e.g. on Owl we haven't been installing it SUID ever (as it was already legacy 15 years ago), and we haven't been packaging it at all since  > In my opinion, this security bug should be fixed two-fold: At first, > kernel should prevent the TIOCGPTN ioctl when invoked called by a > process within one namespace but acting on a filedescriptor from a > devpts instance mounted in a different namespace. Additionally > pt_chown should check via readlink and stat, that the passed file > descriptor really was from the /dev/ptmx or /dev/pts/ptmx device > present in the same namespace as the /dev/pts/[num] device is > residing. This of course is only relevant if pt_chown is going to > survive on recent namespace aware systems.  I think the primary fixes should be different: disable unprivileged user namespaces by default, and drop pt_chown.  > Timeline: > ========= >  >     Discovery >     Report at Ubuntu >     Report to distros list >     Patch to disable unprivileged userns due to this and > other issues LKML >     CRD and publication  Ouch.  As you're aware, everything you report to distros must be made public in at most 2 weeks.  Unfortunately, I didn't keep track of this, and I don't recall if your report to distros included the detail you're disclosing just today.  I thought you had already disclosed whatever was on distros here:   Now I see you were asking for advice on further handling of these issues in there, and got no replies. :-(  I think going forward, you shouldn't make any use of the distros list, and should post to oss-security right away.  > References: > =========== >  > [0] > > [1] >  In [0], "LKML" points to:   Unfortunately, that archive of LKML is currently broken (doesn't display the actual message to me), so I don't know what exactly this was.  I did, however, watch the discussion CC'ed to kernel-hardening, where Kees Cook proposed "sysctl: allow CLONE_NEWUSER to be disabled":   Unfortunately, this was NAK'ed by the maintainer, Eric W. Biederman:   Eric suggested "a per user limit on the number of user namespaces users may create".  There was some further discussion after that point, but no clear outcome.  Last message posted on January 28.  If there's no clear decision upstream, distros must do what they must - disable unprivileged userns ASAP, in whatever way they can.  Alexander  Powered by blists - more mailing lists  Please check out the  Open Source Software Security Wiki, which is counterpart to this mailing list.  Confused about mailing lists and their use? Read about mailing lists on Wikipedia and check out these guidelines on proper formatting of your messages.      