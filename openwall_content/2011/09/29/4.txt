  oss-security - Re: LZW decompression issues            Products  Openwall GNU/*/Linux   server OS Linux Kernel Runtime Guard John the Ripper   password cracker  Free & Open Source for any platform in the cloud Pro for Linux Pro for macOS  Wordlists   for password cracking passwdqc   policy enforcement  Free & Open Source for Unix Pro for Windows (Active Directory)  yescrypt   KDF & password hashing yespower   Proof-of-Work (PoW) crypt_blowfish   password hashing phpass   ditto in PHP tcb   better password shadowing Pluggable Authentication Modules scanlogd   port scan detector popa3d   tiny POP3 daemon blists   web interface to mailing lists msulogin   single user mode login php_mt_seed   mt_rand() cracker  Services Publications  Articles Presentations  Resources  Mailing lists Community wiki Source code repositories (GitHub) Source code repositories (CVSweb) File archive & mirrors How to verify digital signatures OVE IDs  What's new         Follow @Openwall on Twitter for new release announcements and other news   [<prev] [next>] [<thread-prev] [thread-next>] [day] [month] [year] [list]  Date: Thu, 29 Sep From: Tim Zingelman <tez@...bsd.org> To: oss-security@...ts.openwall.com Cc: Tavis Ormandy <taviso@...xchg8b.com>, joerg@...bsd.org Subject: Re: LZW decompression issues  On Thu, Sep 29, at AM, Tomas Hoger <thoger@...hat.com> wrote: > On Thu, 29 Sep Solar Designer wrote: > >> >> >> >> (these are in Attic because we've since updated to gzip 1.4). >> >> As far as I can see, the sanity checks in >> do not overlap with those in FreeBSD's >> latest patch.  These are different sets of checks. > > Tavis also reported an issue in ncompress - - with the > following fix added to ncompress: > > > > It's rather closely related to as it was also creating > prefix loop, via bogus first code.  At the time that was reported, the > case that I originally started to look at (code > free_ent) was already > fixed in ncompress, afaics. > >> As to who originally added the "maxbits < 12" check, when, and why >> exactly (and why this value), I still don't know.  In NetBSD, it is >> added with a commit made 6 weeks ago: >> >> http://cvsweb.netbsd.org/bsdweb.cgi/src/usr.bin/gzip/zuncompress.c?only_with_tag=MAIN >> >> The commit message is merely "Do proper input validation without >> penalizing performance", and it makes several other changes as well >> (FreeBSD in fact reused essentially the same patch). > > The "without penalizing performance" is reference to my original > libXfont one-liner fix that did not prevent loops, only blocked their > impact by checking for stack buffer overflow.  The same kind of fix > Tavis proposed for ncompress to address > > As for < 12, I'm guessing it comes from libXfont too, which had it > before because of this: > >    if (maxbits > BITS || maxbits < 12) >        return 0; >    hsize = hsize_table[maxbits - 12]; > > where: > > static int hsize_table[] = { >         /* 12 bits - 80% occupancy */ >         /* 13 bits - 91% occupancy */ >        /* 14 bits - 91% occupancy */ >        /* 15 bits - 94% occupancy */ >         /* 16 bits - 95% occupancy */ > }; > > This seems to be a re-write of the original: > > #if BITS == 16 > # define HSIZE           /* 95% occupancy */ > #endif > #if BITS == 15 > # define HSIZE           /* 94% occupancy */ > #endif > #if BITS == 14 > # define HSIZE           /* 91% occupancy */ > #endif > #if BITS == 13 > # define HSIZE            /* 91% occupancy */ > #endif > #if BITS <= 12 > # define HSIZE            /* 80% occupancy */ > #endif > > The original seems to allow maxbits < 12. > > NetBSD / FreeBSD uses following: > > #define BITS            16              /* Default bits. */ > #define HSIZE                     /* 95% occupancy */ > > hence maxbits < 12 is probably not needed for the same reason it's > needed in libXfont. > > Anyway, there seems to be an easy way to test.  Can anyone with updated > NetBSD or FreeBSD try this: > >  echo test | compress -b 10 | uncompress >  $ uname -a FreeBSD XXXXXX FreeBSD #0: Wed Sep 28 CDT     toor@...XXX:/usr/obj/usr/src/sys/GENERIC  $ echo test | compress -b 10 | uncompress uncompress: /dev/stdin: Inappropriate file type or format  (on an unpatched FreeBSD it returns 'test' with no error)   - Tim  Powered by blists - more mailing lists  Please check out the  Open Source Software Security Wiki, which is counterpart to this mailing list.  Confused about mailing lists and their use? Read about mailing lists on Wikipedia and check out these guidelines on proper formatting of your messages.      